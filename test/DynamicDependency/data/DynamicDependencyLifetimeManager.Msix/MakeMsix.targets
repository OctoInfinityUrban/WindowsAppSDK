<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. See LICENSE in the project root for license information. -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Define the property MakeMsixVerbosity=high for additional logging (default=normal) -->
  <PropertyGroup>
    <MakeMsixVerbosity Condition="'$(MakeMsixVerbosity)' == ''">normal</MakeMsixVerbosity>
    <MakeMsixSigned Condition="'$(MakeMsixSigned)' == ''">true</MakeMsixSigned>
  </PropertyGroup>

  <Target Name="MakeMSIX" Inputs="@(MakeMsixInputs);@(MakeMsixInputAssets)" Outputs="$(OutDir)\$(TargetName)">
    <!-- Initial state diagnostics -->
    <Message Text="MakeMSIX Pre: MSBuildProjectName=$(MSBuildProjectName)" Importance="$(MakeMsixVerbosity)" />
    <Message Text="MakeMSIX Pre: ProjectName=$(ProjectName)" Importance="$(MakeMsixVerbosity)" />
    <Message Text="MakeMSIX Pre: TargetName=$(TargetName)" Importance="$(MakeMsixVerbosity)" />
    <Message Text="MakeMSIX Pre: MakeMsixInputs=@(MakeMsixInputs)" Importance="$(MakeMsixVerbosity)" />
    <Message Text="MakeMSIX Pre: MakeMsixInputAssets=@(MakeMsixInputAssets)" Importance="$(MakeMsixVerbosity)" />

    <PropertyGroup>
      <_MakeMsix_Architecture>Invalid</_MakeMsix_Architecture>
      <_MakeMsix_Architecture Condition="'$(Platform)' == 'AnyCPU'">neutral</_MakeMsix_Architecture>
      <_MakeMsix_Architecture Condition="'$(Platform)' == 'x86'">x86</_MakeMsix_Architecture>
      <_MakeMsix_Architecture Condition="'$(Platform)' == 'Win32'">x86</_MakeMsix_Architecture>
      <_MakeMsix_Architecture Condition="'$(Platform)' == 'x64'">x64</_MakeMsix_Architecture>
      <_MakeMsix_Architecture Condition="'$(Platform)' == 'arm'">arm</_MakeMsix_Architecture>
      <_MakeMsix_Architecture Condition="'$(Platform)' == 'arm32'">arm</_MakeMsix_Architecture>
      <_MakeMsix_Architecture Condition="'$(Platform)' == 'arm64'">arm64</_MakeMsix_Architecture>
    </PropertyGroup>

    <!-- Ensure TargetName is defined (defining it here if necessary, as per Microsoft.Cpp.Default.props line ~189) -->
    <PropertyGroup>
      <TargetName Condition="'$(TargetName)' == ''">$(ProjectName)</TargetName>
    </PropertyGroup>
    <Message Text="MakeMSIX: TargetName=$(TargetName)" Importance="$(MakeMsixVerbosity)" />
    <Message Text="MakeMSIX: OutDir=$(OutDir)" Importance="$(MakeMsixVerbosity)" />

    <PropertyGroup>
      <!-- <TargetBasename>$(TargetName->'%(Filename)')</TargetBasename> -->
      <TargetExe>$(TargetBasename)</TargetExe>
      <TargetExeDir>$(OutDir)$(TargetExe)</TargetExeDir>
      <TargetExeFile>$(TargetExeDir)\$(TargetExe).exe</TargetExeFile>

      <TargetProxyStub>$(TargetBasename).ProxyStub</TargetProxyStub>
      <TargetProxyStubDir>$(OutDir)$(TargetProxyStub)</TargetProxyStubDir>
      <TargetProxyStubFile>$(TargetProxyStubDir)\$(TargetProxyStub).dll</TargetProxyStubFile>

      <DdlmShadow>DynamicDependencyLifetimeManagerShadow</DdlmShadow>
      <DdlmShadowExe>$(DdlmShadow)</DdlmShadowExe>
      <DdlmShadowExeDir>$(OutDir)$(DdlmShadowExe)</DdlmShadowExeDir>
      <DdlmShadowExeFile>$(DdlmShadowExeDir)\$(DdlmShadowExe).exe</DdlmShadowExeFile>
      <DdlmShadowExePdb>$(DdlmShadowExeDir)\$(DdlmShadowExe).pdb</DdlmShadowExePdb>

      <!-- <VersionInfoDir>$(ProjectDir)</VersionInfoDir> -->
      <!-- <VersionInfoFile>$(VersionInfoDir)Microsoft.WindowsAppRuntime.Release!4.1.0</VersionInfoFile> -->
      <!-- <Message Text="VersionInfoFile=$(VersionInfoFile)" Importance="$(MakeMsixVerbosity)" /> -->
    </PropertyGroup>
    <Message Text="MakeMSIX: TargetExeFile=$(TargetExeFile)" Importance="$(MakeMsixVerbosity)" />
    <Message Text="MakeMSIX: TargetProxyStubFile=$(TargetProxyStubFile)" Importance="$(MakeMsixVerbosity)" />
    <Message Text="MakeMSIX: DdlmShadowExeFile=$(DdlmShadowExeFile)" Importance="$(MakeMsixVerbosity)" />

    <PropertyGroup>
      <MakeMsixTargetDir>$(OutDir)</MakeMsixTargetDir>
      <MakeMsixWorkDir>$(MakeMsixTargetDir)\msix</MakeMsixWorkDir>
      <MakeMsixOutMsix>$(MakeMsixTargetDir)\$(TargetName)</MakeMsixOutMsix>
    </PropertyGroup>
    <Message Text="MakeMSIX: MakeMsixTargetDir=$(MakeMsixTargetDir)" Importance="$(MakeMsixVerbosity)" />
    <Message Text="MakeMSIX: MakeMsixTargetDir=$(MakeMsixTargetDir)" Importance="$(MakeMsixVerbosity)" />
    <Message Text="MakeMSIX: MakeMsixOutMsix=$(MakeMsixOutMsix)" Importance="$(MakeMsixVerbosity)" />

    <PropertyGroup>
      <_MakeMsix_MakeAppxManifestFromTemplate>$(SolutionDir)tools\MakeAppxManifestFromTemplate.cmd</_MakeMsix_MakeAppxManifestFromTemplate>
      <_MakeMsix_MakeAppxManifestFromTemplate_Args>$(ProjectDir)appxmanifest.xml $(MakeMsixWorkDir)\appxmanifest.xml $(_MakeMsix_Architecture)</_MakeMsix_MakeAppxManifestFromTemplate_Args>
      <_MakeMsix_MakeAppxManifestFromTemplateCommand>$(_MakeMsix_MakeAppxManifestFromTemplate) $(_MakeMsix_MakeAppxManifestFromTemplate_Args)</_MakeMsix_MakeAppxManifestFromTemplateCommand>
    </PropertyGroup>

    <PropertyGroup>
      <_MakeMsix_Executable>makeappx.exe</_MakeMsix_Executable>
      <_MakeMsix_Parameters>/o /h SHA256</_MakeMsix_Parameters>
      <_MakeMsixCommand>$(_MakeMsix_Executable) pack $(_MakeMsix_Parameters) $(_MakeMsix_Options) /d $(MakeMsixWorkDir) /p $(MakeMsixOutMsix)</_MakeMsixCommand>
    </PropertyGroup>

    <Message Text="foo1: $(OutDir)\msix" Importance="high" />
    <Message Text="foo2: $(OutDir)\msix" Importance="high" Condition="!Exists('$(OutDir)\msix')" />
    <MakeDir Directories="$(OutDir)\msix" Condition="!Exists('$(OutDir)\msix')" />

    <Message Text="$(_MakeMsix_MakeAppxManifestFromTemplateCommand)" Importance="$(MakeMsixVerbosity)" />
    <Exec Command="$(_MakeMsix_MakeAppxManifestFromTemplateCommand)" />

    <Message Text="MakeMSIX: Copy @(MakeMsixInputs) to $(MakeMsixWorkDir)" Importance="$(MakeMsixVerbosity)" />
    <Copy SourceFiles="@(MakeMsixInputs)" DestinationFolder="$(MakeMsixWorkDir)" SkipUnchangedFiles="true" />

    <Message Text="bar1: $(OutDir)\msix\Assets" Importance="high" />
    <Message Text="bar2: $(OutDir)\msix\Assets" Importance="high" Condition="!Exists('$(OutDir)\msix')" />
    <Message Text="MakeMSIX: Copy @(MakeMsixInputAssets) to $(MakeMsixWorkDir)\Assets" Importance="$(MakeMsixVerbosity)" Condition="'@(MakeMsixInputAssets)' != ''"/>
    <MakeDir Directories="$(OutDir)\msix\Assets" Condition="'@(MakeMsixInputAssets)' != '' and !Exists('$(OutDir)\msix\Assets')" />
    <Copy SourceFiles="@(MakeMsixInputAssets)" DestinationFolder="$(MakeMsixWorkDir)\Assets" SkipUnchangedFiles="true" Condition="'@(MakeMsixInputAssets)' != ''"/>

<!--DeleteMe
    <Message Text="MakeMSIX: Copy $(TargetExeFile) to $(MakeMsixWorkDir)" Importance="$(MakeMsixVerbosity)" />
    <Copy SourceFiles="$(TargetExeFile)" DestinationFolder="$(MakeMsixWorkDir)" SkipUnchangedFiles="true" />
DeleteMe-->

<!--DeleteMe
    <Message Text="MakeMSIX: Copy $(DdlmShadowExeFile) to $(MakeMsixWorkDir)" Importance="$(MakeMsixVerbosity)" />
    <Copy SourceFiles="$(DdlmShadowExeFile)" DestinationFolder="$(MakeMsixWorkDir)" SkipUnchangedFiles="true" />
    <Message Text="MakeMSIX: Copy $(DdlmShadowExePdb) to $(MakeMsixWorkDir)" Importance="$(MakeMsixVerbosity)" />
    <Copy SourceFiles="$(DdlmShadowExePdb)" DestinationFolder="$(MakeMsixWorkDir)" SkipUnchangedFiles="true" />
DeleteMe-->

<!--DeleteMe
    <Message Text="MakeMSIX: Copy $(VersionInfoFile) to $(MakeMsixWorkDir)" Importance="$(MakeMsixVerbosity)" />
    <Copy SourceFiles="$(VersionInfoFile)" DestinationFolder="$(MakeMsixWorkDir)" SkipUnchangedFiles="true" />
DeleteMe-->

    <Message Text="MakeMSIX: Command: $(_MakeMsixCommand)" Importance="$(MakeMsixVerbosity)" />
    <Exec Command="$(_MakeMsixCommand)" />



    <!-- Sign the MSIX -->
    <PropertyGroup>
      <_SignMsix_Executable>signtool.exe</_SignMsix_Executable>
      <_SignMsix_Parameters>/fd SHA256</_SignMsix_Parameters>
      <_SignMsix_UserDir>$(SolutionDir).user\</_SignMsix_UserDir>
      <_SignMsix_PFX>$(_SignMsix_UserDir)winappsdk.certificate.test.pfx</_SignMsix_PFX>
      <_SignMsix_PWD>$(_SignMsix_UserDir)winappsdk.certificate.test.pwd</_SignMsix_PWD>
    </PropertyGroup>
    <Message Text="MakeMSIX: _SignMsix_PWD: '$(_SignMsix_PWD)'" Importance="$(MakeMsixVerbosity)" />
    <ReadLinesFromFile File="$(_SignMsix_PWD)">
      <Output TaskParameter="Lines" ItemName="_SignMsix_PFXPassword"/>
    </ReadLinesFromFile>
    <Message Text="MakeMSIX: _SignMsix_PFXPassword: '@(_SignMsix_PFXPassword)'" Importance="$(MakeMsixVerbosity)" />
    <PropertyGroup>
      <_SignMsixCommand>$(_SignMsix_Executable) sign $(_SignMsix_Parameters) $(_SignMsix_Options) /f "$(_SignMsix_PFX)" /p "@(_SignMsix_PFXPassword)" "$(MakeMsixOutMsix)"</_SignMsixCommand>
    </PropertyGroup>

    <Message Text="MakeMSIX: Sign: $(_SignMsixCommand)" Importance="$(MakeMsixVerbosity)" />
    <Exec Command="$(_SignMsixCommand)" Condition="'$(MakeMsixSigned)' == 'true'"/>
  </Target>
</Project>
