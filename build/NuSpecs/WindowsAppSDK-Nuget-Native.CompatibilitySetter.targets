<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. See LICENSE in the project root for license information. -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="WinAppSDKCompatibilitySetterTarget" BeforeTargets="ClCompile"
          Condition="'$(WindowsAppSDKRuntimePatchMode)' != '' or '$(WindowsAppSDKRuntimePatchMode2)' != '' or '$(WindowsAppSDKDisabledChanges)' != ''">
    <PropertyGroup>
      <WinAppSDKCompatibilitySetterFile>$(GeneratedFilesDir)WinAppSDKCompatibilitySetter.cpp</WinAppSDKCompatibilitySetterFile>
      <WinAppSDKCompatibilityPatchMode1Lines Condition="'$(WindowsAppSDKRuntimePatchMode)' != ''">
            compatibilityOptions.PatchMode1 = new WindowsAppRuntimeVersion($(WindowsAppSDKRuntimePatchMode))%3B
      </WinAppSDKCompatibilityPatchMode1Lines>
      <WinAppSDKCompatibilityPatchMode2Lines Condition="'$(WindowsAppSDKRuntimePatchMode2)' != ''">
            compatibilityOptions.PatchMode2 = new WindowsAppRuntimeVersion($(WindowsAppSDKRuntimePatchMode2))%3B
      </WinAppSDKCompatibilityPatchMode2Lines>
      <WinAppSDKCompatibilityDisabledChangesLines Condition="'$(WindowsAppSDKDisabledChanges)' != ''">
            // TODO: compatibilityOptions.DisabledChanges.AddRange(new uint64_t[] { $(WindowsAppSDKDisabledChanges) })%3B
      </WinAppSDKCompatibilityDisabledChangesLines>
      
      <WinAppSDKCompatibilitySetterFileLines>
// This file is generated by the build based on project properties.
#include &lt;windows.h&gt;
namespace WindowsAppRuntime::Compatibility::Configuration
{
    struct AutoInitialize
    {
        AutoInitialize()
        {
            Initialize()%3B
        }
        
        ~AutoInitialize() = default%3B

        static void Initialize()
        {
            CompatibilityOptions compatibilityOptions%3B
$(WinAppSDKCompatibilityPatchMode1Lines)
$(WinAppSDKCompatibilityPatchMode2Lines)
$(WinAppSDKCompatibilityDisabledChangesLines)
            compatibilityOptions.Apply()%3B
        }
    }%3B
    static AutoInitialize g_autoInitialize%3B
}
</WinAppSDKCompatibilitySetterFileLines>
        </PropertyGroup>
        <WriteLinesToFile
            File="$(WinAppSDKCompatibilitySetterFile)" Lines="$(WinAppSDKCompatibilitySetterFileLines)"
            Overwrite="true"
            WriteOnlyWhenDifferent="true" />
      <ItemGroup>
        <ClCompile Include="$(WinAppSDKCompatibilitySetterFile)">
          <!--
          <CompilerIteration>WinAppSDKGenerated</CompilerIteration>
          -->
          <PrecompiledHeader>NotUsing</PrecompiledHeader>
        </ClCompile>
      </ItemGroup>
    </Target>

  <PropertyGroup>
    <BeforeClCompileTargets>
        $(BeforeClCompileTargets); WinAppSDKCompatibilitySetterTarget
    </BeforeClCompileTargets>
  </PropertyGroup>

</Project>
