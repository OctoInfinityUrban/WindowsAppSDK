<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. See LICENSE in the project root for license information. -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="WinAppSDKCompatibilitySetterTarget" BeforeTargets="XamlPreCompile;CoreCompile"
          Condition="'$(WindowsAppSDKRuntimePatchMode)' != '' or '$(WindowsAppSDKRuntimePatchMode2)' != '' or '$(WindowsAppSDKDisabledChanges)' != ''">
    <PropertyGroup>
      <WinAppSDKCompatibilitySetterFile>$(GeneratedFilesDir)WinAppSDKCompatibilitySetter.cs</WinAppSDKCompatibilitySetterFile>
      <WinAppSDKCompatibilityPatchMode1Lines Condition="'$(WindowsAppSDKRuntimePatchMode)' != ''">
            compatibilityOptions.PatchMode1 = new WindowsAppRuntimeVersion($(WindowsAppSDKRuntimePatchMode.Replace(".", ",")))%3B
      </WinAppSDKCompatibilityPatchMode1Lines>
      <WinAppSDKCompatibilityPatchMode2Lines Condition="'$(WindowsAppSDKRuntimePatchMode2)' != ''">
            compatibilityOptions.PatchMode2 = new WindowsAppRuntimeVersion($(WindowsAppSDKRuntimePatchMode2.Replace(".", ",")))%3B
      </WinAppSDKCompatibilityPatchMode2Lines>

      <WinAppSDKCompatibilityDisabledChangesNoSpaces Condition="'$(WindowsAppSDKDisabledChanges)' != ''">$([System.Text.RegularExpressions.Regex]::Replace($(WindowsAppSDKDisabledChanges), "\s+", ""))</WinAppSDKCompatibilityDisabledChangesNoSpaces>
      <WinAppSDKCompatibilityDisabledChangesLines Condition="'$(WinAppSDKCompatibilityDisabledChangesNoSpaces)' != ''">
            var disabledChangesArray = new CompatibilityChange[] { CompatibilityChange.$([System.Text.RegularExpressions.Regex]::Replace($(WinAppSDKCompatibilityDisabledChangesNoSpaces), ",([A-Za-z])", ", CompatibilityChange.$1")) }%3B
            foreach (var changeId in disabledChangesArray)
            {
                compatibilityOptions.DisabledChanges.Add(changeId)%3B
            }
      </WinAppSDKCompatibilityDisabledChangesLines>

      <WinAppSDKCompatibilitySetterFileLines>
using Microsoft.Windows.ApplicationModel.WindowsAppRuntime%3B

// This file is generated by the build based on project properties.
namespace WindowsAppRuntime.Compatibility.Configuration
{
    class AutoInitialize
    {
        [global::System.Runtime.CompilerServices.ModuleInitializer]
        internal static void ConfigureCompatibility()
        {
            var compatibilityOptions = new CompatibilityOptions()%3B
$(WinAppSDKCompatibilityPatchMode1Lines)
$(WinAppSDKCompatibilityPatchMode2Lines)
$(WinAppSDKCompatibilityDisabledChangesLines)
            compatibilityOptions.Apply()%3B
        }
    }
}
      </WinAppSDKCompatibilitySetterFileLines>
    </PropertyGroup>

    <WriteLinesToFile
        File="$(WinAppSDKCompatibilitySetterFile)" Lines="$(WinAppSDKCompatibilitySetterFileLines)"
        Overwrite="true"
        WriteOnlyWhenDifferent="true" />

    <ItemGroup>    
        <Compile Include="$(WinAppSDKCompatibilitySetterFile)" />    
    </ItemGroup>
  </Target>

</Project>
