# This runs the integration tests directly in the pipeline on the images hosted by the 'WinAppSDK-Test-Pool'.
# This pool is a 1ES Hosted Pool with custom images, which lets us run tests on builds beyond what is
# supported by Helix or the Azure DevOps Microsoft hosted agents. In case of arm64, we use the
# 'WinAppSDK-Test-Pool-Arm64' pool instead, and use parameter isArm64Platfrom to drive pool selection.

parameters:
- name: jobName
  type: string
  default: PipelineTests
- name: isArm64Platfrom
  type: boolean
  default: false
- name: dependsOn
  type: object
  default:
  - ''
  # testMatrix is supplied by WindowsAppSDKConfig/WindowsAppSDK-Foundation-TestConfig.yml
- name: testMatrix
  type: object
  default: ''

jobs:
- job: ${{ parameters.jobName }}
  dependsOn: ${{ parameters.dependsOn }}
  strategy:
    matrix: ${{ parameters.testMatrix }}

  pool:
    type: windows
    isCustom: true
    # arm64 and amd64 use different pools because their VM types are different.
    ${{ if not( parameters.isArm64Platfrom ) }}:
      name: 'WinAppSDK-Test-Pool'
      demands: ImageOverride -equals $(imageName)
    ${{ if parameters.isArm64Platfrom }}:
      name: 'WinAppSDK-Test-Pool-Arm64'
      demands: ImageOverride -equals $(imageName)
  timeoutInMinutes: 120
  variables:
    testPayloadArtifactDir: $(Build.SourcesDirectory)\BuildOutput\$(buildConfiguration)\$(buildPlatform)
  steps:
    - template: WindowsAppSDK-RunTests-Steps.yml
      parameters:
        buildPlatform: $(buildPlatform)
        buildConfiguration: $(buildConfiguration)
        testLocale: $(testLocale)
        ImageName: $(imageName)
