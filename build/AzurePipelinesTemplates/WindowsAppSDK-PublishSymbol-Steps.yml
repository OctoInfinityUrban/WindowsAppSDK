parameters:
- name: "SearchPattern"
  type: string
  default: ""
- name: "IsOfficial"
  type: boolean
  default: False
- name: "PublishPublicSymbolsPowershellPath"
  type: string
  default: "$(Build.SourcesDirectory)/eng/common/Scripts/PublishPublicSymbols.ps1"

steps:
- task: PublishSymbols@2
  displayName: 'Publish private symbols to internal server'
  inputs:
    searchPattern: ${{ parameters.searchPattern }}
    symbolServerType: 'TeamServices'
    indexSources: true
    detailedLog: true
    SymbolsArtifactName: $(symbolsArtifactName)
  env:
    LIB: $(Build.SourcesDirectory)

# Publishing symbols publicly requires making an API call to the service and is handled by PublishPublicSymbols.ps1
# in eng/common
# See this page for more info:
# https://www.osgwiki.com/wiki/Symbols_Publishing_Pipeline_to_SymWeb_and_MSDL
- ${{ if eq(parameters.IsOfficial, 'true') }}:
  - pwsh: |
      Install-Module -Name Az.Accounts -Scope AllUsers -AllowClobber -Force
    displayName: Install Az.Accounts PowerShell module

  # WinAppSDK-AZSC service connection must be used because the service principal created by this connection has been granted read and publish access
  - task: AzurePowerShell@5
    displayName: Publish symbols to SymWeb and MSDL
    inputs:
      azureSubscription: 'WinAppSDK-AZSC'
      ScriptType: 'InlineScript'
      Inline: ${{ parameters.PublishPublicSymbolsPowershellPath }} -RequestName "$(symbolsArtifactName)"
      azurePowerShellVersion: 'LatestVersion'
      pwsh: true
